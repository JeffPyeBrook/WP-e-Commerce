module.exports=function(log,notifs){return Backbone.View.extend({$quantity:null,template:wp.template("wpsc-modal-product"),tagName:"div",id:function(){return"wpsc-modal-cart-item-"+this.model.get("id")},className:function(){var thumbClass=this.model.get("thumb")?"":"no-";var id=this.model.get("id");return"wpsc-cart-item wpsc-cart-item-"+id+" wpsc-cart-"+thumbClass+"thumb"},events:{"click .wpsc-cart-item-edit":"editQty","click .wpsc-cart-item-remove":"maybeRemoveIt","click .wpsc-qty-button":"modifyQty","change .modify-cart-quantity":"quantityChanged"},initialize:function(){this.listenTo(this.model,"change:price",this.render);this.listenTo(this.model,"change:formattedPrice",this.render);this.listenTo(this.model,"change:editQty",this.render);this.listenTo(this.model.collection,"closeModal",this.hideQty);this.listenTo(this,"error",this.handleError)},handleError:function(errorObject){log("Model handleError",errorObject)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},editQty:function(evt){evt.preventDefault();var editQty=this.model.get("editQty");this.model.set("editQty",!editQty)},hideQty:function(){this.model.set("editQty",false)},quantityChanged:function(evt){var $input=this.$(".modify-cart-quantity");var qty=$input.val();if(qty<1){if(this.maybeRemoveIt(evt)){return}qty=1;$input.val(qty)}this.model.save({quantity:qty})},maybeRemoveIt:function(evt){if(window.confirm(notifs.strings.sure_remove)){this.removeIt(evt);return true}return false},removeIt:function(evt){evt.preventDefault();var _this=this;var destroyError=function(model,response){log("destroyError",response);_this.$el.fadeIn(300)};var destroySuccess=function(model,response){if(response.id){log("destroySuccess",response);_this.$el.remove()}else{destroyError(model,response)}};_this.$el.fadeOut(300);this.model.destroy({success:destroySuccess,error:destroyError,wait:true});return true},modifyQty:function(evt){var $button=this.$(evt.currentTarget);var $input=$button.parent().find("input");var oldVal=parseInt($input.val(),10);var newVal=oldVal+1;if("-"===$button.text()){if(oldVal>0){newVal=oldVal-1}else{newVal=0}}$input.val(newVal).trigger("change")}})};